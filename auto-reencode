#!/bin/bash
# Run in the dir containing the target files you wish to convert to x264.
# There are no arguments.
# The script will copy both the audio and video bitrates into the new file
# via metadata from mediainfo and will retain the original DTS for you.

export BLD="\e[01m" RED="\e[01;31m" BLU="\e[01;34m" NRM="\e[00m"

command -v ffmpeg >/dev/null 2>&1 || {
echo -e "${BLD}${RED}I require ffmpeg but it's not installed. Aborting.${NRM}" >&2
exit 1; }

command -v mediainfo >/dev/null 2>&1 || {
echo "${BLD}${RED}I require ffmpeg but it's not installed. Aborting.${NRM}" >&2
exit 1; }

report() {
  echo -e "${BLD}${RED}Task $n of $total${NRM}"
  echo -e "${BLD} file to encode    :${BLU} ${file%.*}"|sed 's|./||'
  echo -e "${NRM}${BLD} video bitrate     : $vkbps kbps${NRM}"
  echo -e "${BLD} audio bitrate     : $akbps kbps${NRM}"
  echo -e "${BLD} play time         : $ptime${NRM}"
}

pass1() {
  # For syntax, see: https://trac.ffmpeg.org/wiki/Encode/H.264 

  # Note that the 3rd line redirects the mbtree and log from the first pass to
  # /tmp which should be tmpfs (on Arch anyway) configured to be 1/2 of the 
  # physical RAM on the machine

  ffmpeg -v quiet -stats -y -i "${file}" \
    -c:v libx264 -preset slow -b:v "$vkbps"k -pass 1 \
    -passlogfile /tmp/ffmpeg2pass \
    -c:a aac -b:a "$akbps"k -f mp4 /dev/null
}

pass2() {
  ffmpeg -v quiet -stats -i "${file}" -c:v libx264 \
    -preset slow -b:v "$vkbps"k -pass 2 \
    -passlogfile /tmp/ffmpeg2pass \
    -c:a aac -b:a "$akbps"k "${file%.*}.mp4"
  
  # remove the 1st pass log and mbtree files
  rm -f /tmp/ffmpeg2pass*
}

IFS=$'\012'
echo 'Enter target file extension [flv,wmv]:'
read -r EXT

# check for files to work on and exit if not are found
if [[ -z $(find . ! -name . -prune -type f -name "*.$EXT" 2>/dev/null) ]]; then
  EXT="flv"
  if [[ -z $(find . ! -name . -prune -type f -name "*.$EXT" 2>/dev/null) ]]; then
    EXT="wmv"
    if [[ -z $(find . ! -name . -prune -type f -name "*.$EXT" 2>/dev/null) ]]; then
      echo -e "${BLD}Cannot find any target files so no work to do.${NRM}"
      echo -e "${BLD}Define a target file type in this dirtree and try again.${NRM}"
      exit 1
    fi
  fi
fi

[[ -z "$EXT" ]] && EXT="flv"

total=$(find . ! -name . -prune -type f -name "*.$EXT"|wc -l)
n=0
for file in $(find . ! -name . -prune -type f -name "*.$EXT"); do

  # find bitrate for video and audio
  vkbps=$(( $(mediainfo --inform="Video;%BitRate%" "$file") / 1000))
  akbps=$(( $(mediainfo --inform="Audio;%BitRate%" "$file") / 1000))
  ptime=$(mediainfo --inform="General;%Duration/String2%" "$file")
  n=$(( n + 1 ))

  report

  # do not overwrite existing files
  if [[ -e "${file%.*}.mp4" ]]; then
    echo >&2 Output file already exists: "${file%.*}.mp4"
    echo >&2 Skipping...
    echo >&2
    continue
  fi

  # encode
  echo -e "${BLD} pass 1 of 2 stats : ${NRM}"

  if pass1; then
    echo -e "${BLD} pass 2 of 2 stats : ${NRM}"
    pass2
  else
    echo -e "${BLD}${RED} Pass 1 failed, exiting!${NRM}"
    exit 1
  fi

  # restore dts
  touch -r "$file" "${file%.*}.mp4"
done

# vim:set ts=2 sw=2 et:
